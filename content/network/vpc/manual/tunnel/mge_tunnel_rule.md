---
title: "管理隧道规则"
description: 介绍如何在 VPC 端添加、修改、删除隧道规则。
keyword: VPC,VPC 网络,GRE 隧道,IPsec隧道
draft: false
weight: 5
---

当您需要通过隧道建立 VPC 与数据中心或 VPC 之间的网络连接时，您需要在隧道两端分别配置隧道规则，建立加密通信通道。本文介绍如何在 VPC 端配置及管理隧道规则。

## 前提条件

已[创建 VPC 网络](../../vpcnet/10_create_vpc/)。

## 添加隧道规则

1. 登录管理控制台，选择**产品与服务** > **网络服务** > **VPC 网络**，进入 VPC 列表页面。

1. 在 VPC 列表，找到您需要进行隧道配置的 VPC 网络，点击 VPC 网络名称，进入详情页。

2. 切换至**管理配置**页签，然后点击**隧道服务** > **添加隧道规则**。

   ![](../../../_images/tunnel_service.png)

3. 根据界面提示，配置隧道参数。

   ![](../../../_images/add_tunnel_rule.png)

   隧道协议可选 `GRE` 及 `IPsec`，不同协议，配置参数不同。

   - 配置 GRE 隧道，请参见 [GRE 隧道参数说明](#gre-隧道参数)。
   - 配置 IPsec 隧道，请参见 [IPsec 隧道参数说明](#ipsec-隧道参数)。

4. 点击**提交**进行保存，返回**隧道服务**页面，可看到已添加的隧道规则。

### GRE 隧道参数

| 参数          | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| 名称          | 隧道名称。<br/>按需自定义。                                  |
| 远端路由器    | 对端网络网关设备的公网 IP 地址或域名。<br/>对端网络可以是您本地数据中心、本地办公网络或云平台上其他 VPC 网络。<br/>如果对端网络为同一区域下的 VPC， 此处可填写对端 VPC 的 ID，实现内网互联。其他情况下，则必须填写对端网络合法的公网 IP 或域名。 |
| 协议          | 隧道协议。<br/>配置 GRE 隧道选择 `GRE`。                     |
| 密钥（可选）  | 隧道两端共同约定的整型数字，用于隧道连接的身份认证。<br/>本端与对端配置的密钥需要一致。<br/>有效范围为 [1, 2^32 -1]。 |
| 本地点对点 IP | 隧道在本端的 IP 地址。<ul><li>不同隧道的点对点地址网段必须唯一，不能重复。</li><li>本端与对端 IP 需在同一网段。</li></ul> |
| 对端点对点 IP | 隧道在对端的 IP 地址。                                       |
| 目标网络      | 需要与当前 VPC 通信的对端网络的私网网段。<br/>可添加多个目标网络。目标网络不能和 VPC 网络已有的私有网络重复。 |



### IPsec 隧道参数

| 参数                | 说明                                                         |
| ------------------- | ------------------------------------------------------------ |
| 名称                | 隧道名称。<br/>按需自定义。                                  |
| 远端路由器          | 对端网络网关设备的公网 IP 地址或域名。<br/>对端网络可以是您本地数据中心、本地办公网络或云平台上其他 VPC 网络。<br/>如果对端网络为同一区域下的 VPC， 此处可填写对端 VPC 的 ID，实现内网互联；其他情况下，需填写对端网络合法的公网 IP 或域名。<br/>如果对端没有固定 IP，可填 0.0.0.0。 |
| 协议                | 隧道协议。<br>配置 IPsec 隧道选择 `IPsec`。                  |
| 远端设备 ID（可选） | 用于标识远端设备。<br/>勾选**匹配任意 ID** 表示随机生成一个 ID。<br/>若不填写，则其值与远端路由器 IP 相同。 |
| 密钥（可选）        | 隧道两端共同约定的任意字符串，用于隧道连接的身份认证。<br/>本端与对端配置的密钥需要一致。 |
| 加密方法            | 选择数据加密算法、认证算法及 DH 分组。                       |
| 隧道模式            | 选择协商模式。<ul><li>主模式：协商过程安全性高。</li><li>野蛮模式：协商快速且协商成功率高，但安全性较低，易受到拒绝服务和暴力攻击。</li></ul> |
| 开启 PFS            | 选择是否 PFS（Perfect Forward Secrecy，全前向保密）。<br/>开启后，安全性更好。 |
| IKE 版本            | 选择 IKE 协议的版本。<ul><li>IKEv2 Only：使用 IKEv2。 </li><li>IKEv1 Only：使用 IKEv1</li><li>自动匹配：系统自动匹配。</li></ul>相对于 IKEv1 版本，IKEv2 版本简化了 SA 的协商过程并且对于多网段的场景提供了更好的支持，也更加安全，建议选择 IKEv2 版本。 |
| 本地网络            | 需要和对端互通的 VPC 侧的私有网络网段。<br/>点击**添加更多本地网络**，可添加多个需要和对端互通的 VPC 私有网络。 |
| 目标网络            | 需要和 VPC 互通的对端私网网段。<br/>点击**添加更多目标网络**，可添加多个需要和 VPC 互通的对端私有网段。<div style="background-color: #D8ECDE; padding: 10px 24px; margin: 10px 0; border-left: 3px solid #00a971;"><b>说明</b><br/>目标网络不能和 VPC 网络已有的私有网络重复。</div> |
| 健康检查 IP         | 用于健康检查的目标地址。<br/>该地址必须在目标网络中且可以 ping 通。<br/>可配置多个，也可不配置。不配置，表示不启用健康检查。 |
| 健康检查源 IP       | 用于健康检查的源地址。<br/><ul><li>关闭：若未配置健康检查 IP，则选择关闭。 </li><li>开启：若配置了健康检查 IP，则需要开启。源 IP 为系统指定，不能手动配置。</li></ul><div style="background-color: #D8ECDE; padding: 10px 24px; margin: 10px 0; border-left: 3px solid #00a971;"><b>注意</b><br/>若开启，需要将健康检查源 IP 配置到隧道目标感兴趣流，否则可能会导致隧道网络不通。</div> |

## 复制隧道规则

您可以将已添加的隧道规则复制到其他区域进行应用。

1. 在 VPC 列表，找到想要复制隧道规则的源 VPC 网络，点击 VPC 网络名称，进入详情页。

2. 切换至**管理配置**页签，然后点击**隧道服务** > **复制隧道规则**，弹出**复制隧道规则**窗口。

   ![](../../../_images/copy_tunnel_rule_1.png)

3. 点击**选择隧道规则**，在弹出的窗口中勾选您需要复制的源规则（可多选），然后点击**提交**。

   ![](../../../_images/copy_tunnel_rule_2.png)

4. 选择目标 VPC 所在区域及具体 VPC。

5. 点击**复制**。

   复制成功后，即可在目标 VPC 下查看到同样的隧道规则。

   > 说明
   >
   > 您需要在目标 VPC 的详情页，点击**应用修改**，规则才会生效。

## 修改隧道规则

您可以修改已经添加的隧道规则。

1. 在 VPC 列表，点击 VPC 网络名称，进入详情页。

2. 切换至**管理配置**页签，然后点击**隧道服务** ，进入**隧道服务**页面。

3. 将鼠标移到需要禁用或启用的隧道规则上，然后点击**修改**，弹出**修改隧道属性**窗口。

   ![](../../../_images/modify_tunnel.png)

4. 修改隧道属性值，点击**提交**。

   此处不可修改目标网络及本地网络（IPsec 隧道）。

   可通过以下方式修改：

   - GRE 隧道：点击**目标网络**之后的**展开**，然后可添加、修改或删除目标网络。

     ![](../../../_images/mdfy_gre_tunnel_des_net.png)

   - IPsec 隧道：点击**感兴趣流**之后的**展开**，然后可添加感兴趣流组，以及添加、修改、删除本地网络及目标网络。

     ![](../../../_images/mdfy_ipsec_tunnel_des_net.png)

5. 点击**应用修改**，更新 VPC 网络。

## 禁用/启用隧道规则

您可以将暂时不需要的隧道规则禁用，等待需要时重新启用即可。

1. 在 VPC 列表，点击 VPC 网络名称，进入详情页。

2. 切换至**管理配置**页签，然后点击**隧道服务** ，进入**隧道服务**页面。

3. 将鼠标移到需要禁用或启用的隧道规则上，然后点击**禁用**/**启用**，弹出确认提示框。

   ![](../../../_images/disable_tunnel.png)

4. 点击**确认**，禁用/启用该隧道规则。

   > **说明**
   >
   > 禁用后，隧道规则失效。

5. 点击**应用修改**，更新 VPC 网络。


## 删除隧道规则

您可以删除不再使用的隧道规则。删除后不可恢复。

1. 在 VPC 列表，点击 VPC 网络名称，进入详情页。

2. 切换至**管理配置**页签，然后点击**隧道服务** ，进入**隧道服务**页面。

3. 将鼠标移到需要删除的隧道规则上，然后点击**删除**，弹出确认提示框。

   ![](../../../_images/delete_tunnel.png)

4. 点击**确认**，删除该隧道规则。

5. 点击**应用修改**，更新 VPC 网络。
