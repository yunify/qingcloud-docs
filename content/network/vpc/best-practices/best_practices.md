---
title: "跨越 VPC，大规模安全自由组网"
linkTitle: "跨越 VPC，大规模安全自由组网"
date: 2020-02-28T10:08:56+09:00
description:
draft: false
weight: 1
---



当企业业务本身非常复杂时，VPC 内云服务器数量的增长会导致`防火墙规则`数量指数级爆炸增长，将严重消耗网络性能。

例如青云现有客户中，某大型国有企业在各地市有子公司，母公司和子公司下属都有很多个部门，多套 IT 系统：人力资源管理系统、生产管理系统、信息管理系统、财务管理系统等。

不同子公司、部门、系统的数据都需要`隔离`，如果用防火墙做隔离，复杂的防火墙规则不仅降低网络性能，还非常容易出错，一旦出错影响的可能是整个公司的业务和信息安全。

这时更好的办法，可以充分利用 VPC 自身的隔离功能，因为 VPC 是 100% 的二层隔离，所以`天生安全`。

但是如何打通 VPC ，并且保证网络的稳定性和性能，是拦在众多开发者前面的一个难题。


## 总览

本文旨在帮助用户，如何利用青云 QingCloud 网络组件，跨越多个 VPC， `自由`构建`安全`、`超大规模`的 2 ~ 3 层网络。


## 一、多个 VPC 简单组网

青云 QingCloud 的 VPC 产品本身带有`免费`的 NAT 网关和 VPN 网关功能，可以用于 VPC 内云服务器对外提供服务。

### NAT

NAT ( Network Address Translation )是将一个公网IP转换为很多个内网IP的技术,最常见的IP复用技术之一。NAT 解决的是公网IPv4地址数量限制的问题，在1981年IPv4协议的发布只考虑到全球不到50亿的人口。

所以IP复用对于互联网的后来者就相当重要，青云QingCloud 的 VPC 支持源地址转换（简称“源NAT”）和目的地址转换（简称“端口转发”）。

通过源 NAT , VPC 内部发起连接的计算机的IP地址将会被重写，VPC 内的云服务器数据包能够到达外网云服务器，可以对公网中的服务发起请求。

给 VPC 绑定一个公网 EIP ，会自动配置[源 NAT 功能](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2)

VPC 内`所有机器`可以使用 VPC 的公网地址去访问公网，就不再需要每台机器绑定公网IP地址。

![](../_images/best_1.jpg)

通过端口转发，VPC内被连接的云服务器IP地址将被重写，使得外网云服务器发出的数据包能够到达内网云服务器

端口转发通过转发公网 IP 的不同端口给不同云服务器，VPC 内的不同机器可以使用 VPC 的公网地址的`不同端口`来对外提供服务。

![](../_images/best_2.jpg)

但是，例如常见的HTTP 和 HTTPS 服务需要用 80 端口和 443 端口对公网提供服务，由于端口转发一个端口只能对应后端一台服务器，所以 NAT 网关不适用大规模的 Web 服务。
所以，VPC 的 NAT 网关对于单一端口的应用和服务不具备广泛`适用性`，并不是很适用构建大量的跨 VPC 服务。

### 隧道和 VPN 服务

VPN ( Virtual Private Network )是基于加密技术，在公网上构建加密的专用网络。使得传输的数据即便被非法截获，也难以被破解。

在 VPC 内还可以使用隧道服务，基于 Internet，通过加密通道将企业数据中心、企业办公网络、或 Internet 终端、VPC 和 VPC 安全连接起来。

![](../_images/best_3.jpg)

VPN 服务也是基于 Internet 的传输加密方式，在单台机器而非整个网络连接 VPC 内网时可以通过输入登录名密码的方式简单实现。

![](../_images/best_4.jpg)

然而，虽然隧道和 VPN 对数据进行了加密，但是仍然完全依赖公网链路，所以无法避免公网的波动导致的网络不稳定。


如果 VPN 和隧道经过的网络链路出现丢包和高延迟，势必仍然会导致网络服务的波动。

>利用 VPC 自身的 NAT 和 VPN 组件可以应用在需要少量的跨VPC服务场景下。如果需要大规模高性能的跨VPC通信，我们建议采用性能更好稳定性更高的方案--内网路由器。

## 二、搭建`自治网络`，跨越 VPC 边界

重申一下，本文中跨越 VPC 并不是因为 VPC 不够强大，相反青云 QingCloud 的 VPC 由于采用了 DVR 技术, VPC 内最多可以有63504个云服务器。

如开篇所述，为了满足业务和安全的要求，网络规模非常庞大，安全策略异常复杂的情况，青云 QingCloud 还设计开发了[内网路由器](https://docs.qingcloud.com/product/network/intranet_router)。

![](../_images/best_5.jpg)

内网路由器可以将企业内网从单一路由的 VPC 网络，扩展为一个虚拟的自治系统[( Autonomous Systems )](https://en.wikipedia.org/wiki/Autonomous_system_(Internet))。
在这个架构图中，我们做了两个重要的改进，以便真正去适用大规模复杂的网络：
1.青云的虚拟路由器是分布在各个物理计算节点的分布式路由器 DVR (Distributed Virtual Router)，由于数据包并未真正汇聚到某个虚拟路由器中，所以避免了单点故障和单点性能瓶颈。

2.内网路由器运行在物理交换机上，性能和稳定性都远远强于虚拟路由器，物理交换机之间还存在bonding，防止单点故障。

通过内网路由器实现不同 VPC 之间的私有网络直接三层互通，所以`内网路由器`是整个虚拟网络的[核心路由器。](https://baike.baidu.com/item/%E6%A0%B8%E5%BF%83%E8%B7%AF%E7%94%B1%E5%99%A8/5901585?fr=aladdin)

所以青云 QingCloud 的网络，在逻辑上和物理网络基本已经没有区别，而且完全摆脱了命令行，一样管理您的 “自治网络” 。

![](../_images/best_6.jpg)

在青云控制台中，您可以选择需要关联内网路由器的私有网络 Vxnet
内网路由器在三层转发的性能远远超过普通的 VPC ，所以也可以将内网路由器`绑定到 VPC `加强 VPC 的内网PPS和带宽性能。

和物理网络类似的是，在内网路由器里加入私有网络 Vxnet 后，您需要在私有网络所在的 VPC 配置`内网路由策略`，将对目标网络的`下一跳`指向内网路由器。

![](../_images/best_7.jpg)

>青云内网路由器可以作为核心路由器用于组建自治系统级别的网络，还也可以打通不同区域的 VPC，利用青云的骨干网在公有云上构建真正的“两地三中心”网络。
## 三、巧用核心路由，云上构建“两地三中心”的网络

对 IT 企业来说，传统的单数据中心，已不足以保护企业数据的安全。为此，青云 QingCloud 专门在 PEK3a / PEK3 / SH1A / GD2 区域之间搭建了物理专线，方便大型企业打造容灾的网络架构。

![](../_images/best_8.jpg)

通过内网路由器+网关（+青云专线）的方式，可以直接利用青云机房间的专线，从物理链路层实现高可靠，打通不同可用区之间的 VPC ,在公有云上实现“两地三中心”的网络架构。
构建“两地三中心”的网络，与上一节中搭建“自治网络”的操作一致，只需要额外在每个业务可用区部署一个网关

![](../_images/best_9.jpg)

完整的操作步骤请见[详情](https://docs.qingcloud.com/product/sd_wan/quick_start/vpc_connect_vpc)

>青云内网路由器除了作为公有云的核心路由器，也可以作为公有云的“边界路由”，与私有云的边界设备打通，构建“`云网一体化`”方案。

## 四、构建云上云下“云网一体化”

内网路由器还可以用于承接来自边界网关和 SD-WAN 的流量，发挥`边界路由`作用,与 SD-WAN 共同构建跨多地域多 VPC，云上云下一体的“`云网一体化`”方案。

[SD -WAN](https://docs.qingcloud.com/product/sd_wan/quick_start/cpe_connect_vpc)接入不受地域限制，只需要盒子连接公网；[专线接入](https://docs.qingcloud.com/product/sd_wan/quick_start/line_connect_vpc)目前覆盖北上广一线城市，提供物理链路支持。

![](../_images/best_10.jpg)

青云的城域网产品天生为了打造企业级 `WAN` 网，为数据中心的双活和多活提供网络助力。

企业 `WAN` 网采用最新的 SD-WAN 方案，接入方式可以选择普通`宽带接入`或者`物理专线接入`，还支持 `MPLS/VPN` 和 `4G LTE` 等多种接入方式。

![](../_images/best_11.jpg)

青云的企业“WAN”网可以让您轻松摆脱运营商网络抖动、丢包问题，具备实时监控隧道质量, 动态链路切换的功能。同时可以即插即用，无需二次部署和配置。

## 综述
在青云 QingCloud ，可以利用内网路由器的“核心路由”能力，跨越不同地域的多个VPC进行组网，帮助 B 端客户实现真正的大规模、安全、多容灾的服务网络。

内网路由器运行在物理交换机上，可以将内网路由器`绑定到 VPC `加强 VPC 的内网PPS和带宽性能。

私有云用户也可以通过 SD-WAN 或专线与公有云中的内网路由器打通，构建混合云和云网一体化的企业`WAN`网。

>FAQ
：1.为什么不提负载均衡器LB？

因为负载均衡器功能定位属于 4 ~ 7 层设备，依赖 2 ~ 3 层的互通，而不是去实现 2 ~ 3 层互通。
也就是说，已有网络ping不通，是不可能通过负载均衡器LB解决的，除非您绑定一个公网IP。但这种方式的互通是公网IP去实现的，有无负载均衡器都实现了互通。
而且，很多只对内网开放的服务（比如开发测试环境）是不允许绑定公网 IP 的，从成本来说也是浪费公网的流量。
