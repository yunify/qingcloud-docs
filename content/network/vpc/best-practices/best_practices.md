---
title: "跨越 VPC，大规模安全自由组网"
keyword: QingCloud, 青云, 云计算, VPC, VPC 网络, 跨 VPC 组网
description: 介绍如何跨越 VPC，大规模安全自由组网。
draft: false
weight: 1
---

本文旨在帮助用户，如何利用云平台中的网络组件，构建跨越多个 VPC 的大规模网络。

## 适用场景

当企业业务本身非常复杂时，VPC 内云服务器数量的增长会导致防火墙规则数量指数级爆炸增长，将严重消耗网络性能。

例如，某大型国有企业客户，在各地市有子公司，母公司和子公司下属都有很多个部门，多套 IT 系统：人力资源管理系统、生产管理系统、信息管理系统、财务管理系统等。不同子公司、部门、系统的数据都需要隔离，如果用防火墙做隔离，复杂的防火墙规则不仅降低网络性能，还非常容易出错，一旦出错影响的可能是整个公司的业务和信息安全。

这时，便可以充分利用 VPC 网络自身的隔离功能，组建安全的大规模网络。因 VPC 网络 100% 二层隔离，所以天然具备安全可靠性。

- 您可以利用内网路由器的“核心路由”能力，跨越不同地域的多个 VPC 进行组网，帮助 B 端客户实现真正的大规模、安全、多容灾的服务网络。
- 内网路由器运行在物理交换机上，可以将内网路由器绑定到 VPC 加强 VPC 的内网 PPS 和带宽性能。
- 私有云用户也可以通过 SD-WAN 或专线与公有云中的内网路由器打通，构建混合云和云网一体化的企业 WAN网。

## 组网方案

### 方式一：多个 VPC 简单组网

VPC 自身的 NAT 功能 和 VPN 组件，可以应用在小规模的跨 VPC 通信场景下，例如用于 VPC 内云服务器对外提供服务。

#### 通过 VPC 的 NAT 功能

VPC 网络支持源地址转换（简称“源 NAT”）和目的地址转换（简称“端口转发”）。

通过源 NAT , VPC 内部发起连接的计算机的IP地址将会被重写，VPC 内的云服务器数据包能够到达外网云服务器，可以对公网中的服务发起请求。

给 VPC 绑定一个公网 IP ，会自动配置源 NAT 功能，VPC 内所有机器可以使用 VPC 的公网地址去访问公网，就不再需要每台机器绑定公网IP地址。

![](../_images/best_1.jpg)

端口转发通过转发公网 IP 的不同端口给不同云服务器，VPC 内的不同机器可以使用 VPC 的公网地址的不同端口来对外提供服务。

![](../_images/best_2.jpg)

但是，例如常见的 HTTP 和 HTTPS 服务需要用 80 端口和 443 端口对公网提供服务，由于端口转发一个端口只能对应后端一台服务器，所以 NAT 网关不适用大规模的 Web 服务。

所以，VPC 的 NAT 网关对于单一端口的应用和服务不具备广泛适用性，并不是很适用构建大量的跨 VPC 服务。

#### 通过隧道和 VPN 服务

VPN ( Virtual Private Network )是基于加密技术，在公网上构建加密的专用网络。使得传输的数据即便被非法截获，也难以被破解。

在 VPC 内还可以使用隧道服务，基于 Internet，通过加密通道将企业数据中心、企业办公网络、或 Internet 终端、VPC 和 VPC 安全连接起来。

![](../_images/best_3.jpg)

VPN 服务也是基于 Internet 的传输加密方式，在单台机器而非整个网络连接 VPC 内网时可以通过输入登录名密码的方式简单实现。

![](../_images/best_4.jpg)

然而，虽然隧道和 VPN 对数据进行了加密，但是仍然完全依赖公网链路，所以无法避免公网的波动导致的网络不稳定。


如果 VPN 和隧道经过的网络链路出现丢包和高延迟，势必仍然会导致网络服务的波动。



### 方式二：搭建自治网络，跨越 VPC 边界

如果需要大规模高性能的跨 VPC 通信，我们建议采用性能更好稳定性更高的方案——内网路由器。内网路由器可以将企业内网从单一路由的 VPC 网络，扩展为一个虚拟的自治系统(Autonomous Systems)。其架构图如下：

![](../_images/best_5.jpg)


**架构说明**：

- 虚拟路由器是分布在各个物理计算节点的分布式路由器 DVR (Distributed Virtual Router)，由于数据包并未真正汇聚到某个虚拟路由器中，所以避免了单点故障和单点性能瓶颈。

- 内网路由器运行在物理交换机上，性能和稳定性都远远强于虚拟路由器，物理交换机之间还存在bonding，防止单点故障。

- 通过内网路由器实现不同 VPC 之间的私有网络直接三层互通，所以内网路由器是整个虚拟网络的核心路由器。在逻辑上，云上的网络和物理网络已基本没有区别，且完全摆脱了命令行，能够以可视化界面管理您的 “自治网络” 。

**操作方法**：

1. 在控制台中，您可以选择需要关联内网路由器的私有网络 Vxnet，内网路由器在三层转发的性能远远超过普通的 VPC ，所以也可以将内网路由器绑定到 VPC，加强 VPC 的内网 PPS 和带宽性能。
    ![](../_images/best_6.jpg)

2. 在内网路由器里加入私有网络 Vxnet 后，您需要在私有网络所在的 VPC 配置内网路由策略，将对目标网络的下一跳指向内网路由器。

    ![](../_images/best_7.jpg)

### 方式三：巧用核心路由，云上构建“两地三中心”的网络

对 IT 企业来说，传统的单数据中心，已不足以保护企业数据的安全。为此，青云 QingCloud 专门在 PEK3a / PEK3 / SH1A / GD2 区域之间搭建了物理专线，方便大型企业打造容灾的网络架构。

通过内网路由器+网关（+青云专线）的方式，可以直接利用机房间的专线，从物理链路层实现高可靠，打通不同可用区之间的 VPC ,在公有云上实现“两地三中心”的网络架构。

构建“两地三中心”的网络，与上一节中搭建“自治网络”的操作一致，只需要额外在每个业务可用区部署一个网关。完整的操作步骤请见 [VPC 跨区互联](/sd-wan/sdwan/quick-start/vpc_connect_vpc/)。

![](../_images/best_8.jpg)


![](../_images/best_9.jpg)



### 方式四：构建云上云下“云网一体化”

内网路由器除了作为公有云的核心路由器，也可以作为公有云的“边界路由”，与私有云的边界设备打通，构建“云网一体化”方案。

内网路由器可以用于承接来自边界网关和 SD-WAN 的流量，发挥边界路由作用，与 SD-WAN 共同构建跨多地域多 VPC，云上云下一体的“云网一体化”方案。

[SD-WAN](https://docs.qingcloud.com/product/sd_wan/quick_start/cpe_connect_vpc)接入不受地域限制，只需要盒子连接公网；[专线接入](https://docs.qingcloud.com/product/sd_wan/quick_start/line_connect_vpc)目前覆盖北上广一线城市，提供物理链路支持。

![](../_images/best_10.jpg)

企业 WAN 网采用最新的 SD-WAN 方案，接入方式可以选择普通宽带接入或者物理专线接入，还支持 MPLS/VPN 和 4G LTE 等多种接入方式，让您轻松摆脱运营商网络抖动、丢包问题，具备实时监控隧道质量, 动态链路切换的功能。同时可以即插即用，无需二次部署和配置。

![](../_images/best_11.jpg)



## FAQ
**Q**：为什么不提负载均衡器？

**A**：负载均衡器功能属于 4 ~ 7 层设备，依赖 2 ~ 3 层的互通，而不是去实现 2 ~ 3 层互通。若已有网络 ping 不通，是无法通过负载均衡器解决的。除非您绑定一个公网 IP。但这种方式的互通是公网 IP 去实现的，也并非通过负载均衡器实现了互通。并且，针对只对内网开放的服务（比如开发测试环境），是不允许绑定公网 IP 的，从成本来说也是浪费公网的流量。
