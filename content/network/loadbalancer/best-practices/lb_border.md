---
title: "使用负载均衡器实现跨地域的高可用网络服务"
description: 介绍如何使用负载均衡器实现跨地域的高可用网络服务。
keyword: 负载均衡器, 高可用
draft: false
---

本节描述如何灵活运用 VPC、边界路由器、路由表、负载均衡器，搭建使用不同区域的云服务器作为后端的负载均衡服务，从而实现多地域的高可用网络服务。

## 场景示例

在北京3区创建两个VPC 网络，在广东2区创建一个VPC网络，并在三个 VPC 网络下分别创建一台云服务器，通过边界路由器及 SD-WAN 网关，将这三个不同 VPC 下的云服务器互联，并添加到同一个负载均衡器的后端服务器中。

## 资源规划

| 区域    | 资源名称         | 资源类型          | 规划网段/IP/说明                   |
| ------- | ---------------- | ----------------- | ---------------------------------- |
| 北京3区 | 北京演示VPC1     | VPC 网络          | 172.16.0.0/16                      |
| 北京3区 | 北京演示VPC2     | VPC 网络          | 172.17.0.0/16                      |
| 北京3区 | 北京演示vxnet1   | 私有网络          | 172.16.1.0/24                      |
| 北京3区 | 北京演示vxnet2   | 私有网络          | 172.17.1.0/24                      |
| 北京3区 | 北京演示主机1    | 云服务器          | 172.16.1.2                         |
| 北京3区 | 北京演示主机2    | 云服务器          | 172.17.1.2                         |
| 北京3区 | 北京边界路由器1  | 边界路由器        | 关联北京演示vxnet1及北京演示vxnet2 |
| 北京3区 | 演示公网 IP      | 公网 IP           | 139.198.18.135                     |
| 北京3区 | 跨Region负载均衡 | 负载均衡器        | 绑定公网 IP及北京演示vxnet1        |
| 北京3区 | 北京网关         | SD-WAN 网关接入点 | 关联北京边界路由器1                |
| 广东2区 | 广东演示VPC1     | VPC 网络          | 192.168.0.0/16                     |
| 广东2区 | 广东演示vxnet1   | 私有网络          | 192.168.211.0/24                   |
| 广东2区 | 广东演示主机1    | 云服务器          | 192.168.211.2                      |
| 广东2区 | 广东边界路由器1  | 边界路由器        | 关联广东演示vxnet1                 |
| 广东2区 | 广东网关         | SD-WAN 网关接入点 | 关联广东边界路由器1                |



## 步骤一：利用边界路由器打通同区域 VPC

青云的边界路由器可以连接多种不同的网络场景，本步骤中主要使用边界路由器连接同区域下不同 VPC 网络。

网络架构如图所示：

![](../_images/lb+region1.png)

1. 在北京3区，创建两个 VPC 网络。

   1. 在菜单栏，选择**产品与服务** > **网络服务** > **VPC 网络**，进入**VPC 网络**页面。

   2. 点击**创建 VPC 网络**，创建出 2 个 CIDR 不同的 VPC 网络。

      本操作中，分别创建了：

      北京演示VPC1：VPC 地址范围为 172.16.0.0/16，初始私有网络为“北京演示 vxnet1”，私有网络地址段为 172.16.1.0/24。

      北京演示VPC2：VPC 地址范围为 172.17.0.0/16，初始私有网络为“北京演示 vxnet2”，私有网络地址段为 172.17.1.0/24。

      ![](../_images/lb+region2.png)

      ![](../_images/lb+region6.png)

      ![](../_images/lb+region7.png)

2. 在私有网络“北京演示 vxnet1”及“北京演示 vxnet2”中，分别创建一台云服务器。

   1. 在私有网络“北京演示 vxnet1”下，创建云服务器“北京演示主机1”。

      服务器配置：镜像选择 CentOS 7.5 64 bit，指定对应的 IP 地址为 172.16.1.2。

   2. 在私有网络“北京演示 vxnet2”下，创建云服务器“北京演示主机2”。

      服务器配置：镜像选择 CentOS 7.5 64 bit，指定对应的 IP 地址为 172.17.1.2。

      ![](../_images/lb+region10.png)

3. 创建和配置边界路由器。

   1. 在菜单栏，选择**产品与服务** > **网络服务** > **边界路由器**，进入**边界路由器**页面。

   2. 点击**创建**，创建边界路由器， 命名为“北京边界路由器1”。

      ![](../_images/lb+region13.png)

   3. 进入边界路由器页面，点击 **关联VPC私有网络**。

   4. 选择私有网络 “北京演示vxnet1” 和 “北京演示vxnet2”，点击**提交**。

      ![](../_images/lb+region15.png)

4. 配置内网路由策略，VPC1 与VPC2 互指路由。

   1. 进入VPC “北京演示VPC1” 详情页面，点击“管理配置” > “内网路由策略”。

      ![](../_images/lb+region16.png)

   2. 点击 “添加规则”，下一跳选择 “北京边界路由器1”，目标网络 “172.17.1.0/24”，提交。

      ![](../_images/lb+region17.png)

   3. 点击右上角“应用修改”，将规则修改同步到管理后台。

   4. 按照同样方法，进入 VPC “北京演示VPC2” 详情页面，添加规则下一跳选择 “北京边界路由器1”，目标网络 “172.16.1.0/24”，并应用修改。

      ![](../_images/lb+region19.png)

5. 登录云服务器间验证网络通信。

   1. 登录 “北京演示云服务器1”，执行命令 ip a，查看本机网络信息；执行 ping 172.17.1.2。

      ![](../_images/lb+region21.png)

   2. 登录 “北京演示云服务器2”，执行命令 ip a，查看本机网络信息；执行 ping 172.16.1.2。

      ![](../_images/lb+region22.png)

## 步骤二：利用 SD-WAN 网关打通不同区域 VPC


使用边界路由器及 SD-WAN 服务实现 VPC 私有网络云服务器与另一个区的 VPC 私有网络云服务器网络互通，网络架构如下：

![](../_images/lb+region61.png)

1. 切换至 “广东2区”，创建一个 VPC 网络。

   1. 在菜单栏，选择**产品与服务** > **网络服务** > **VPC 网络**。

   2. 点击**创建 VPC 网络**，创建 “广东演示VPC1”。

      VPC 地址范围为 192.168.0.0/16，初始私有网络为“广东演示vxnet1”，私有网络地址段为 192.168.211.0/24。

      ![](../_images/lb+region23.png)

2. 在私有网络“广东演示vxnet1”中，创建一台云服务器 “广东演示云服务器1”。

   云服务器配置：镜像选择 CentOS 7.5 64 bit，指定对应的 IP 地址为 192.168.211.2。

3. 登录云服务器，验证网络隔离。

   ![](../_images/lb+region26.png)

4. 创建和配置边界路由器。

   1. 在菜单栏，选择**产品与服务** > **网络服务** > **边界路由器**，进入**边界路由器**页面。

   2. 点击**创建**，创建边界路由器， 命名为“广东边界路由器1”。

      ![](../_images/lb+region27.png)

   3. 进入边界路由器页面，点击**关联VPC私有网络**。

      ![](../_images/lb+region28.png)

   4. 选择私有网络 “广东演示vxnet1” ，点击**提交**。

      ![](../_images/lb+region29.png)

5. 创建SD-WAN网关。

   1. 在菜单栏，选择**产品与服务** > **SD-WAN** > **网关**。

   2. 点击**创建接入点**。

      ![](../_images/lb+region30.png)

   3. 选择可用区 “北京 3 区” 后，选择计费模式，点击**提交**。

      ![](../_images/lb+region31.png)

   4. 再次点击**创建接入点**，选择可用区 “广东 2 区” 后，选择计费模式，点击**提交**。

      ![](../_images/lb+region32.png)

6. 为 VPC3 配置内网路由策略，路由指向 VPC1 与 VPC2。

   1. 进入 VPC 网络 “广东演示VPC1”详情页，添加内网路由策略。

      ![](../_images/lb+region33.png)

   2. 点击 “添加规则”，下一跳选择 “广东边界路由器1”，目标网络 “172.16.1.0/24” 名称 “gdvxnet1-bjvxnet1”，目标网络 “172.17.1.0/24” 名称 “gdvxnet1-bjvxnet2”。

      ![](../_images/lb+region34.png)

   3. 点击**应用修改**。

7. 为 VPC1 和 VPC2 配置内网路由策略，路由指向 VPC3。

   1. 在 “北京 3 区” 区域，进入VPC “北京演示VPC1”，添加内网路由策略，下一跳 “北京边界路由器1”，目标网络 “192.168.211.0/24”，名称 “bjvxnet1-gdvxnet1”，点击提交并应用修改。

      ![](../_images/lb+region36.png)

      ![](../_images/lb+region37.png)

   2. 在 “北京 3 区” 区域，进入VPC “北京演示VPC2”，添加内网路由策略，下一跳 “北京边界路由器1”，目标网络 “192.168.211.0/24”，名称 “bjvxnet2-gdvxnet1”点击提交并应用修改。

      ![](../_images/lb+region38.png)

      ![](../_images/lb+region39.png)

8. 验证 VPC1、VPC2、VPC3之间的网络通信。

   1. 登录 “广东演示云服务器1”，验证与 “北京演示云服务器1” 和 “北京演示云服务器2” 的通信。

      ![](../_images/lb+region40.png)

   2. 登录 “北京演示云服务器1”，验证与 “广东演示云服务器1” 的通信。

      ![](../_images/lb+region41.png)

   3. 登录 “北京演示云服务器2”，验证与 “广东演示云服务器1” 的通信。

      ![](../_images/lb+region42.png)

## 步骤三：搭建跨区域的高可用负载均衡服务

在“北京演示VPC1”中创建 LB，根据上文中的网络架构，负载均衡VIP地址与 VM1/VM2/VM3 都已经处于三层可达状态，所以可以添加三个云服务器作为后端服务器，网络架构如图所示：

![](../_images/lb+region62.png)

1. 申请公网 IP。

   1. 在北京 3 区，选**产品与服务** > **网络服务** >**公网 IP**，进入**公网 IP**页面。

   2. 点击**申请**，提示备案相关信息，点击 **继续申请公网IP**，填写公网 IP 参数，名称设置为 “演示公网 IP”，然后点击**提交**。

      ![](../_images/lb+region44.png)

   3. 查看申请的公网 IP为：139.198.18.135 (以系统实际分配 IP 为准)

      ![](../_images/lb+region45.png)

2. 创建负载均衡器，添加云服务器“北京演示主机1”和“北京演示主机2”为后端。

   1. 在北京 3 区，选**产品与服务** > **网络服务** >**负载均衡器**，进入**负载均衡器**页面。

   2. 点击**创建**，创建负载均衡器。

      负载均衡器配置：点击**添加公网IPv4** 选择 “演示公网IP”，并选择私有网络 “北京演示vxnet1”，命名负载均衡器为 “跨Region负载均衡”。

      ![](../_images/lb+region46.png)

   3. 点击进入负载均衡器详情页，点击**创建监听器**。

   4. 设置名称 “网站负载均衡” ，协议选择“HTTP” ，端口“80”，点击**提交**。

      ![](../_images/lb+region47.png)

   5. 点击**添加后端**，在弹出的窗口中，选择私有网络“北京演示vxnet1”、云服务器“北京演示主机1”，端口 80，点击**提交**。

      ![](../_images/lb+region48.png)

   6. 再次点击**添加后端**，在弹出的窗口中，选择私有网络“北京演示vxnet2”、云服务器“北京演示主机2”，端口 80，点击**提交**。

      ![](../_images/lb+region49.png)

3. 负载均衡器添加云服务器“广东演示主机1”为后端。

   1. 点击**添加后端**，**网络类型**选择“IP”，输入“广东演示主机1”的 IP 地址 “192.168.211.2”，端口 80，点击**提交**。

      ![](../_images/lb+region50.png)

   2. 点击 “应用修改”，使负载均衡器配置生效。

4. 为负载均衡器添加路由表。

   1. 在北京 3 区，在页面左侧导航树，选择**网络** > **路由表**。

   2. 点击**创建**，创建路由表。

      ![](../_images/lb+region52.png)

   3. 点击进入路由表详情页，点击 “添加路由”，目标网络 “192.168.211.0/24”，名称 “跨Region路由”，下一跳 “172.16.1.254”。

      ![](../_images/lb+region53.png)

   4. 点击 “添加路由”，目标网络 “172.17.1.0/24”，名称 “跨VPC路由” ，下一跳 “172.16.1.254”

      ![](../_images/lb+region54.png)

   5. 将路由表绑定到“跨Region负载均衡器”  ，并点击**应用修改**。

## 步骤四：验证负载均衡服务

为三台云服务器“北京演示云服务器1”、“北京演示云服务器2”、“广东演示云服务器1”部署 httpd 服务。

1. 输入命令`yum install –y httpd`

   ![](../_images/lb+region55.png)

2. 安装完成后，输入命令 `service httpd start` 和 `chkconfig httpd on`，启动 httpd 服务。

   ![](../_images/lb+region56.png)

3. 在/var/www/html下，输入命令 `vi index.html`，新建 index.html 并编辑。
   分别将 “北京演示云服务器1”、 “北京演示云服务器2” 、“广东演示云服务器1” 填入到相应云服务器的 index.html

   ```
   <h1 style="text-align:center;">
         <span style="color:#60D978;">北京演示云服务器1</span>
   </h1>
   <p style="text-align:center;">
           青云@QingCloud
   </p>	
   ```

   

4. 使用浏览器访问负载均衡器绑定的公网 EIP 地址 `139.198.18.135` ，查看网页效果，利用浏览器刷新按钮查看轮询的云服务器切换效果，分别显示效果如下。

   ![](../_images/lb+region58.png)

   ![](../_images/lb+region59.png)

   ![](../_images/lb+region60.png)

至此跨 Region 的负载均衡器就搭建完毕了。
