---
title: "捕获镜像"
description: 本章节主要介绍镜像的相关概念。
draft: false
keyword: 镜像, 捕获镜像, 制作镜像
weight: 20
alias:
  - /compute/image/intro/image/
---

本章节介绍如何捕获镜像。

## 通过云服务器备份捕获镜像

### 前提条件

已创建云服务器且云服务器处于**关机**状态。

### 创建备份

1. 登录管理控制台。

2. 选择**产品与服务** > **计算** > **云服务器**，进入**云服务器列表**页面。

   ![](/compute/vm/_images/vm_server_list.png)

3. 点击**鼠标右键**，弹出菜单窗口。

   > **说明**
   >
   > 您也可以勾选待克隆的云服务器，选择**更多操作** > **创建备份**，批量创建云服务器备份。

   <img src="/compute/vm/_images/vm_capture_image.png" style="zoom:50%;" />

4. 点击**创建备份**，弹出提示信息。

5. 若已阅读并了解提示信息的注意事项，点击**继续**，弹出**创建备份**窗口。

   <img src="/compute/vm/_images/vm_bak_win.png" style="zoom:50%;" />

6. 输入备份名称，并根据需要勾选是否创建新的备份链。

7. 点击**提交**，完成备份操作。

### 制作新镜像

1. 备份创建完成后，选择**存储** > **备份**，进入**备份**页面。

2. 鼠标右键点击已创建的备份，弹出菜单窗口。

   <img src="/compute/vm/_images/vm_new_images.png" style="zoom:40%;" />

3. 点击**制作成新镜像**，弹出**根据云服务器备份制作镜像**窗口。

   <img src="/compute/vm/_images/vm_new_images_encrypt.png" style="zoom:50%;" />

4. 根据需要配置相关参数。

2. 点击**提交**，完成新镜像制作操作。

### 查看制作的新镜像

1. 镜像制作完成后，选择**计算** > **镜像** > **自有镜像**，进入自有镜像页面。

2. 查看根据云服务器备份制作的镜像。

   <img src="/compute/vm/_images/vm_owner_images.png" style="zoom:50%;" />

## 通过数据盘备份捕获镜像

用户也可以将自定义镜像上传到云服务器挂载的硬盘中，使用硬盘的快照制作成用户自定义的镜像。

### 约束限制

- 挂载到云服务器的硬盘必须是本地盘，云盘不支持通过备份创建镜像。关于本地盘和云盘的详细信息，请参见[硬盘类型](/storage/disk/intro/introduction/#硬盘类型)。
- 用户自定义的镜像创建的云服务器不能重置密码。
- 某些监控信息可能采集不到。
- 不支持使用lvm分区的镜像。
- 根据自定义的镜像文件创建的云服务器在挂载硬盘后硬盘的映射关系无法显示(即 vol-XXX 和 /dev/sdX 之间的映射关系)。
- 自定义的镜像的大小不能超过设置的值，公有云中不能超过 100G 不能小于 20G。

### 注意事项

- 在使用自定义的系统盘创建自定义镜像时，务必保证 /etc/fstab 的信息和系统盘内分区一致。
- 确保 `/boot/grub/grub.cfg`，`/boot/grub/menu.list` （不同操作系统对应文件不一样）等文件可以正确引导启动。
- 确保网口配置为 DHCP 能够自动获取 IP 地址。

### 操作步骤

示例：

将本地的 20G 系统盘的镜像上传到青云环境上。 务必确保本地系统盘上的 `/etc/fstab`，`/etc/network/` 等文件信息正确。

1. 云服务器创建新的硬盘（硬盘类型选择为**本地盘**），大小也为 20G （和本地系统盘的大小一致；如果系统盘的大小小于 20G，也需要创建 20G 的硬盘）。

2. 初始化新创建的硬盘，并挂载新创建的硬盘到某台云服务器上。

3. 拷贝本地的 `test2.img` 镜像文件到云服务器上。

   `scp -i $KEY_PATH test2.img root@eip:~/`

4. 云服务器安装 qemu 软件支持使用 qemu-img 转换格式，或者在本地转换也可以（如果用户本地转换格式，此步骤可省略）。

   `sudo apt-get install qemu kernel-package linux-source build-essential`

5. 将 test2.img（假定是 qcow2 格式的镜像），转化为 raw 格式；也可以直接转化成 raw 格式后拷贝到云服务器。

   `qemu-img convert -f qcow2 test2.img -p -O raw test_raw.img`

6. 如果镜像的大小小于新创建的硬盘，使用如下指令修改镜像的大小 （当镜像的大小和新创建的硬盘一致时，忽略此步骤）。 必须保证raw格式的镜像大小和硬盘大小一致，之后才能使用dd拷贝镜像到新创建的硬盘。

   例如：镜像的大小只有 128M ，此时将镜像的大小调整为新创建的硬盘的大小 20G 。

   `qemu-img resize test.img +19G`

   `qemu-img resize test.img +896M`

7. 将 raw 格式的镜像文件拷贝到新创建的硬盘中。

   `dd if=test_raw.img of=/dev/vdc`

   完成之后， `lsblk` 如果没有显示 `vdc` 的分区信息，可以使用如下命令。

   `partprobe /dev/vdc`

   更新下硬盘的分区信息。

8. 在左侧导航栏中，选择**存储** > **硬盘**，将新创建的硬盘制作备份。

9. 选择**存储** > **备份**，将新硬盘的备份制作成新镜像，创建用户自定义镜像。

   <img src="/compute/vm/_images/capture-image-from-vol-snapshot.png" style="zoom:50%;" />

10. 创建镜像完成后，选择**计算** > **镜像** > **自有**，可查看创建的镜像。

    勾选创建的镜像， 并点击**基于镜像创建云服务器**，可以创建新的云服务器。

    用户也可以自己制作云硬盘中的分区， 并将已有的镜像的分区逐个上传到硬盘中，再安装好 `grub` 和引导文件。
