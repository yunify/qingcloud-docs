xxx---》yyy 代表原来的xxx改成yyy样。

高可用M 增加了监控，创建页面原来是14.4现场改成了只有大版本号，例如14.4改成14。

# 产品动态

## 什么是PostgreSQL

应用版本，增加PG 12. 13. 14（没有postgis插件）。 通过多层松耦合的架构设计，青云可以最快时间提供最新版本的pg。

## 产品规格

### 版本介绍

采用一主一从的经典高可用架构，提供数据库高可用保障服务。主从节点可以通过修改配置参数设置同步流复制或者异步流复制模式。 ---》 采用一主一从的经典高可用架构，提供数据库高可用保障服务。主从节点可以通过修改配置参数设置同步流复制或者异步流复制模式。2.0以上采用一主多从的主实例架构，2个主实例时，采用半同步模式，即当备机出现问题时，不会影响主机的业务，同时健康检查会报告集群出现错误，当采用3个主实例时，只允许1个备机出现错误，当两个备机都出现故障时，将影响主节点的写入，因此拥有更高的安全性。

## 应用版本

12.9 13.7 14.4 ---》 12.12 13.8 14.5

### 性能规格

可以参考创建页面调整下，现在这个与创建的差别比较大。主机默认是e3. 而且和原来项目增加了增强型SSD。SSD这个加不加到文档都行。

- 【基本设置】的图片更新下。（隐藏了小内核）

# 快速入门

## 创建集群（PG V2.0.0及以上）

第一个图片，是PG11的，可以换一下2.0.0的，可以引用》操作只能2.0-》集群生命周期-》查看集群信息的地一个图片

### 主实例设置/只读实例 自定义

磁盘 增加了 增强型SSD

### 连接数据库（增加下 PG V2.0.0 及以上）

- 1、获取连接信息。


- - 1）在集群管理页面，点击目标集群 ID，进入集群详情页面。
  - 2）在服务端口信息模块或节点列表，获取高可用 IP 地址或节点 IP 地址。

![img](https://cdn.nlark.com/yuque/0/2022/png/25774644/1663050626847-1b3b5bff-290d-4eb1-88fe-9538f7e1f0d7.png)

- 2、创建用户。（引用到 操作指南（PG V2.0 及以上中的账户管理））
- 3、访问数据库。

| 选项 | 说明                                                         | 示例          |
| ---- | ------------------------------------------------------------ | ------------- |
| -U   | 数据库用户账号名。- 获取更多用户信息，请参见[用户管理](http://139.198.1.69:8080/database/postgresql/manual/mgt_account/user_account)。 | root          |
| -h   | 数据库节点的 IP 或者双节点集群的 VIP。                       | 192.168.100.0 |
| -d   | 数据库名称。                                                 | postgres      |
| 密码 | 数据库用户密码。                                             | qingcloud1234 |

### 连接数据库示例

- 1、使用创建的用户，输入如下命令，并输入密码，访问目标数据库。

```
psql -U root -h 172.16.0.239 -d postgres
```

- 2、创建业务数据库（需要连接的用户权限为 高级权限）

```
create database production;
```

- 3、执行命令\l，查看当前 PostgreSQL 数据库信息。

回显如下：

![img](https://cdn.nlark.com/yuque/0/2022/png/25774644/1663051478146-8ff79c8a-d27c-41ca-9cb7-b69a65b066b2.png)

# 操作只能指南（PGV2.0以上）

## 数据库连接

参照快速入门 -> 连接数据库。

## 集群生命周期

### 集群概述

可以参考本文上部分版本介绍的内容调整下。

### 查看集群信息

可将请求在所有节点之间进行负载分担 ---》 默认可将请求在出primary节点外的所有节点间进行负载分担

#### 配置参数

图片更新。

#### 节点角色

- master表示数据库主库。
- standby表示数据库从库。
- unknown表示集群状态不稳定，暂未识别主备库状态。
- readonly：表示集群只读节点

### 升级版本

- 仅支持集群同系列的版本升级。例如PG11-高可用版-1.0.5可升级到PG V2.0.0-高可用版。 应该是1.0.5 到 1.0.6 或 2.0.0 到 2.0.1

仅支持PG 11及以下版本升级到PG V2.0及以上版本。---- 可以去掉。 只有2.0 的才能升级到2.0. 2.0以下的只能迁移

### 续费

手动续费，图片过期

### 退订

操作步骤，图片过期

## 节点生命周期

### 节点概述

参考 版本介绍 部分，

### 新增节点

【节点参数】，【节点数量】说明中，Proxy 实例默认为0，最多可选择2个。---》去掉

### 删除节点

- 不支持删除主实例节点。 -》 不支持删除主实例全部节点

### 变更同步模式

主实例是半同步模式。允许1个节点出问题后，不影响primary节点的读写。

- 2 主实例集群：半同步模式。允许一个节点故障，此时集群无法故障转移，不会影响 primary 节点读写。
- 3 主实例集群：增强半同步模式。允许一个节点宕机，为了保证数据的强一致性，两节点宕机会阻塞主节点写入，此时集群只读。

建议使用 3主实例集群。

只读实例，可以设置同步/异步

- synchronous_readonly 参数控制只读实例同步模式


- - sync：只读实例同步。
  - async：只读实例异步（默认）。

建议设置只读实例为 async。

![img](https://cdn.nlark.com/yuque/0/2022/png/25774644/1663052505398-2e773379-edc9-42c3-89b7-d9ffb0210fbe.png)

## 账户管理

### 用户账户概述

#### 自定义账号

关系型数据库 PostgreSQL 支持管理 **高级权限**和**普通权限** 两种权限类型用户账号。

| 账号类型 | 权限范围                                                 | 说明                                                         |
| -------- | -------------------------------------------------------- | ------------------------------------------------------------ |
| 高级权限 | 具备 Superuser、CREATEDB、CREATEROLE、REPLICATION 权限。 | 一个集群支持支持创建多个高级权限账号。                       |
| 普通权限 | 具备其创建表、索引、Schema 等数据库对象的管理权限。      | 一个集群支持创建多个普通账号。普通账号不能创建和管理其他账号。 |

#### 默认账号

创建 PostgreSQL 集群时，系统默认同步创建 postgres、pgautofailover_replicator、pgautofailover_monitor 等运维管理账号。

默认集群没有业务账户及数据库，需要在 console 创建高级权限账户，并通过该账户进行管理。

### 添加账号

创建 PostgreSQL 集群时，默认不会创建账号。集群创建成功后，您需要手动添加高级权限和普通权限账号。

本小节主要介绍如何创建 PostgreSQL 数据库账号。

#### 约束限制

- 不支持创建同名账号。
- 不支持创建 postgres、pgautofailover_replicator、pgautofailover_monitor 等账号。

![img](https://cdn.nlark.com/yuque/0/2022/png/25774644/1663053462036-9e92a0fc-fdcb-44ac-95b5-96a5301fb230.png)

#### 账号参数

| 参数       | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| 角色       | 默认为管理节点。                                             |
| 账号       | 输入数据库用户账户名。不支持添加 postgres、pgautofailover_replicator、pgautofailover_monitor 等账号。为确保账号名唯一性，不支持添加同名账号。命名规则：长度为 2～26 个字符数；只能由大写字母（A～Z)、小写字母（a～z）、数字（0～9）和特殊字符（_）组成。 |
| 数据库密码 | 输入数据库密码。密码规则：长度为 8～32 位字符数；必须同时包含大写字母（A～Z)、小写字母（a～z）、数字（0～9）和特殊字符（@#%^&*_+-=）。 |
| 用户权限   | 选择账号权限类型。可选择普通权限或高级权限。                 |

### 重置账号密码

图片更新

### 删除账号

在 AppCenter 集群管理控制台，支持删除已创建的 PostgreSQL 数据库账号。

注意

-数据库账号删除后不可找回，请谨慎操作。

-请勿以任何方式删除 postgres、pgautofailover_replicator、pgautofailover_monitor等管理账号，以免数据库系统异常。

-若删除账号仍具有相应数据库、表或者对象的权限，则实际删除会失败。请取消权限后再次尝试。

- 不支持删除postgres、pgautofailover_replicator、pgautofailover_monitor等管理账号。

图片更新。

## 配置参数

### 参数介绍

该参数修改后，将重启 pgpool。---》该参数修改后，将重启 postgresql 服务，请在业务低峰期进行操作。

重启参数：

- 端口
- wal_level
- shared_buffers
- max_connections
- max_worker_processes

可能会造成重启的参数：

- temp_buffers
- work_mem
- maintenance_work_mem

由于参数自动调优，可能间接造成 max_connections 参数修改，进而引起postgresql 服务重启。

参数的下方[restart]  代表修改参数会重启， [restart-mayby]代码修改参数可能会重启，[unit： MB] unit 代表参数的单位，  0 is automatic set 代表该参数会根据当前的主机配置进行自动设置

### 修改配置参数

图片更新。

## 监控与告警

### 监控指标

#### 服务监控指标

| 监控项           | 子监控项         | 监控周期 | 单位   | 指标含义                                                     |
| ---------------- | ---------------- | -------- | ------ | ------------------------------------------------------------ |
| 连接信息         | 连接数           | 5分钟    | counts | 统计当前连接到PostgreSQL 的总连接数以个为单位。              |
|                  | 未使用连接数     | 5分钟    | counts | 统计当前还能连接到PostgreSQL 的总连接数以个为单位。          |
| 事务信息         | 事务提交数       | 5分钟    | counts | 统计当前 PostgreSQL 的事务总数。以次为单位。                 |
|                  | 事务回滚数       | 5分钟    | counts | 统计当前 PostgreSQL 的回滚事务总数。以次为单位。             |
| 元组信息         | 插入元组数       | 5分钟    | counts | 统计当前 PostgreSQL 的插入元组的数量。以个为单位。           |
|                  | 更新元组数       | 5分钟    | counts | 统计当前 PostgreSQL 的更新元组的数量。以个为单位。           |
|                  | 删除元组数       | 5分钟    | counts | 统计当前 PostgreSQL 的删除元组的数量。以个为单位。           |
| 最大事务持续时间 | 最大事务持续时间 | 5分钟    | s      | 统计当前 PostgreSQL 最大的事务持续时间。以秒为单位。         |
| 数据块信息       | 读取缓存块数     | 5分钟    | counts | 统计在数据库内存中读取的数据块数，每个块8KB                  |
|                  | 读取磁盘块数     | 5分钟    | counts | 统计在磁盘中读取的数据块数，每个块8KB                        |
| 缓存命中率       | 缓存命中率       | 5分钟    | counts | 对所有块的数量进行统计， 命中率= 缓存块数/（缓存块数+磁盘块数） |

### 设置监控告警

#### 告警项说明

| 告警项           | 推荐值           | 告警说明                                             |
| ---------------- | ---------------- | ---------------------------------------------------- |
| CPU利用率        | 80%              | 检测 CPU 使用率。若 CPU 过高会导致性能下降、崩溃等。 |
| 内存使用率       | 80%              | 检测内存使用率。若持续增高会导致数据库不可用。       |
| 磁盘使用量       | 80%              | 检测硬盘使用率。若磁盘满会导致数据无法落盘。         |
| 节点服务状态     | 1                | 检测服务是否可用。                                   |
| 连接数           | 根据实际规格调整 | 检测当前连接到 PostgreSQL 的总连接数。               |
| 缓存命中率       | <50              | 检测缓存命中率。                                     |
| 未使用连接数     | <100             | 检测当前 PostgreSQL 剩余可用连接数。                 |
| 最大事务持续时间 | >1800            | 检测长事务。                                         |

### 查看资源和服务监控

图片更新。

## 日志管理

### 在线查看日志

连接postgres 数据库，可以看到对应日期的日志表，通过查询相应日期的表可以在线查看数据库的日志。

集群创建后，可通过 console-> 日志查看集群日志（primary节点日志）

![img](https://cdn.nlark.com/yuque/0/2022/png/25774644/1663057938965-6911131e-1076-42b7-b23f-2068590a79ff.png)

慢日志查看：

- 1、修改【配置参数】console_log


- - log：显示集群日志
  - calls：根据 SQL 调用次数显示慢日志。
  - mean_time：根据 SQL 平均时间显示慢日志。
  - total_time：根据 SQL 总运行时间显示慢日志。
  - max_time：根据 SQL 最大执行时间显示慢日志。


- 2、查看日志：

![img](https://cdn.nlark.com/yuque/0/2022/png/25774644/1663058134692-fcd9ce48-7af0-4fb7-a297-a328b488c0c3.png)