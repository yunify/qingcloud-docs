---
title: "灾备集群设置"
description: 本小节主要介绍如何进行 PostgreSQL 灾备集群设置。 
keyword: 灾备集群设置,PostgreSQL,关系型数据库,数据库
weight: 15
collapsible: false
draft: false

---

PostgreSQL 集群支持将另一区域 PostgreSQL 集群设置为**源集群**，提供集群灾备服务。

## 前提条件

* 已有源集群和已创建灾备集群。

  >* 源集群 A：192.168.100.4（primary）、192.168.100.5（standby）、192.168.100.253（高可用写 IP）
  >* 灾备集群 B：192.168.100.6（primary）、192.168.100.7（standby）、192.168.100.250（高可用写 IP）

* 已获取管理控制台登录账号和密码，且已获取集群操作权限。

* 已创建 PostgreSQL 集群，且集群状态为**活跃**。

* 源集群与灾备集群状态为活跃服务正常，且已获取源集群高可用 IP 和端口。

* 灾备集群与源集群的应用版本需升级到 PG11-高可用版-V1.0.8、PG9.6-高可用版-V1.1.6、PG10-高可用版-V1.1.6，或以上版本。

* 灾备集群与源集群的网络需通畅，可通过[边界路由器](https://docsv3.qingcloud.com/network/border_router/)或 [VPN](https://docsv3.qingcloud.com/network/vpc/manual/vpn/) 等方式打通网络。

* 灾备集群与源集群的 PostgreSQL 内核版本需一致。

* 灾备集群的`max_connections`、`max_worker_processes`、`max_wal_senders`、`max_prepared_transactions`、`max_locks_per_transaction`配置参数值不小于源集群参数值。

##  操作步骤

### 步骤 1、向源集群 A 写入数据

1. 登录管理控制台。

2. 选择**产品与服务** > **数据库与缓存** > **关系型数据库 PostgreSQL**，进入集群管理页面。

   可查看当前区域集群列表，以及集群基本信息。

3. 选择源集群 A，点击源集群的 ID，进入集群详情页面。

   记录高可用写 IP 地址。

4. 使用高可用写 IP 地址连接源集群 A 的数据库，详细操作请参见[连接数据库](/database/postgresql/manual/mgt_connect/access_pg/)。

5. 向集群A不断插入数据（初始时集群A、B都没有数据）

   ![插入数据](../../_images/backup_config_01.png)

###  步骤2、将集群 B 设置为集群 A 的灾备集群

1. 登录管理控制台。

2. 选择**产品与服务** > **数据库与缓存** > **关系型数据库 PostgreSQL**，进入集群管理页面。

   可查看当前区域集群列表，以及集群基本信息。

3. 选择源集群 B，点击集群 B 的 ID，进入集群详情页面。

4. 在**基本属性**模块，点击集群操作下拉菜单。

5. 展开下拉菜单，点击**启动灾备**。

   ![启动灾备](../../_images/backup_config_02.png)

6.  填写参数并启动灾备。

   * 源集群端口：输入源集群 A 运行的端口号。
   * 描述：简要描述源集群信息。
   * 是否使用同步方式同步数据：选择是否选用同步方式同步数据。
     * 是，则使用同步方式同步数据，实时同步数据。
     * 否，则使用异步方式同步数据，延时同步数据，可能导致数据丢失。
   * 源集群地址：输入源集群 A 的高可用 IP 地址。

   ![启动灾备](../../_images/backup_config_03.png) 

### 步骤 3、验证数据

1. 登录管理控制台。

2. 选择**产品与服务** > **数据库与缓存** > **关系型数据库 PostgreSQL**，进入集群管理页面。

   可查看当前区域集群列表，以及集群基本信息。

3. 选择源集群 B，点击源集群的 ID，进入集群详情页面。

   记录高可用写 IP 地址。

4. 使用高可用写 IP 地址连接源集群 B 的数据库，详细操作请参见[连接数据库](/database/postgresql/manual/mgt_connect/access_pg/)。

   验证数据是否同步（包括新插入的增量数据）

   ![验证数据](../../_images/backup_config_04.png)  

   >**说明**
   >
   >* 当集群A发生自然灾害等状况时，可快速将业务切换至灾备集群B，及时恢复业务。
   >* 若想取消集群 B 到集群 A 的数据同步，可运行停止灾备。之后集群 B 将独立运行。

 