---
title: "异地容灾"
description: test
weight: 112
draft: false
---

异地灾备功能支持将 MySQL Plus 集群作为另一个可用区的 MySQL Plus 集群的灾备集群，并且支持设置源集群永久只读或可写、灾备集群提升、 数据回迁到源集群、停止灾备以及灾备集群上展示灾备关系等功能。

本小节主要介绍如何启动、停止灾备功能，以及简要介绍启动灾备后如何迁移数据等。

## 启动灾备

若源集群与当前集群不在同一 VPC 下，可使用边界路由器（vpc board）或 VPN 等方式打通**源集群**与当前集群的网络。

1. 在当前集群点击**启动灾备**，选择数据同步方式。
2. 填写**源集群**信息并提交。
   
   - 若选择**全量+增量**同步方式，该集群会去源集群复制全量数据，并作为备库从源集群同步增量数据。

   - 若选择**增量**同步方式，需确保该集群已有源集群的全量数据，例如该集群是基于源集群的最新备份创建的集群。
3. 执行成功后当前集群即为**灾备集群**。

>   **注意**
> 1. 启动灾备执行成功前，源集群不要执行 DDL 语句。    
> 2. 启动灾备执行成功后，灾备集群的主节点高可用功能会暂时失效，即主节点发生故障不会自动切换。
> 3. 启动灾备执行成功后，灾备集群的**重启集群**和**更新参数**功能会暂时禁用。**重启集群**执行失败，**更新参数**会延迟生效。

![启动灾备](../../_images/start_standby.png)

## 停止灾备

 若在执行**启动灾备**后，不想再作为**灾备集群**，或极端情况下想将业务强制切换到该集群，则在**灾备集群**上执行**停止灾备**。

## 切换至灾备集群

若需将业务切换到**灾备集群**。

1. 先在源集群点击**开关只读**选择 **ON** 开启源集群永久只读。

2. 在灾备集群上点击**提升灾备**。
   若检测到数据与源集群一致，会自动停止灾备并使该集群可写，反之则报错。

3. 将业务连接数据库的地址改为灾备集群的 VIP，业务切换到灾备集群。

## 切换至源集群

若**源集群**恢复后，想将业务切回去，需先回迁数据（将**源集群**作为**灾备集群**的灾备）。

1. 在源集群执行**启动灾备**，填写灾备集群信息。

2. 在灾备集群执行**开关只读**，选择 **ON** 开启灾备集群永久只读。

3. 在源集群执行**提升灾备**。
   若检测到数据与灾备集群一致，会自动停止灾备并使该集群可写，反之则报错。

4. 在源集群执行**开关只读**，选择 **OFF** 关闭源集群永久只读以保证业务可写。
  
5. 将业务连接数据库的地址改为源集群的 VIP，业务切换到源集群。

> **注意**
> - **源集群**需提供具有 super 权限和复制权限的账户用于**灾备集群****启动灾备**。
> - 若将数据从**灾备集群**回迁到**源集群**，则**源集群**需升级到 `1.5.6` 及以上版本。
> - 若**源集群**非 QingCloud MySQL Plus 集群，需确保其 MySQL 内核版本为 `5.6` 或 `5.7`，且开启了 GTID 模式。


## 注意事项

- 以上**启动灾备**后暂时失效或禁用的功能，在**灾备集群****停止灾备**、**提升灾备**或关闭再启动集群后会自动生效或恢复。

- **停止灾备**、**提升灾备**、关闭再启动集群都会使**灾备集群**不再从**源集群**同步数据。

- **启动灾备**前两个集群均需设置如下参数。 
   `connect_timeout=30`、`max_allowed_packets=1G`、`slave_pending_jobs_size_max=1G`、`interactive_timeout=3600`、`wait_timeout=3600`、`net_read_timeout=1800`、`net_write_timeout=1800`
