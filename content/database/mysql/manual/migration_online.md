---
title: "在线迁移"
description: test
weight: 5
draft: false
---


迁移服务可以将远端 MySQL 数据库的数据平滑迁移到 QingCloud MySQL Plus 集群中。目前支持迁移的 MySQL 版本为 5.6 & 5.7 & 8.0。

支持 `xtrabackup` 方式和 `mysqldump` 两种迁移方式，数据量大时，xtrabackup 迁移速率会快很多。

![在线迁移](../../_images/migrate_data.png)

## mysqldump 方式迁移

### 操作步骤

1. 若原库与当前集群不在同一 VPC 下，使用 边界路由器（vpc board） 或 VPN ，打通原库与当前集群的网络。
2. 点击「 在线迁移 」，将原库 MySQL 账户名（要有 super 权限 和 复制权限）、密码、端口、IP 地址、远端集群ID 填入下图所示文本框，并选择 xtrabackup 为 `NO`， 点击「 提交 」即开始迁移。
3. 等待「 在线迁移 」服务完成。服务执行完成后，当前集群就成功获取了原库的全量数据并与原库配置了主从关系，如此则可以持续同步原库增量数据到当前集群。
4. 若当前集群与原库同版本且同私有网络，可执行交换预留IP来快速切换业务。否则，按第5步切换业务。
5. 选择合适时段，切换业务到当前集群（切换时，远端 MySQL 必须要停写以保证数据一致性）：
   1. 停止原库的业务。
   2. 校验当前集群与原库数据是否一致，若一致，则继续下一步。
   3. 点击 「 结束迁移 」，会自动重启 MySQL 集群。
   4. 将业务所连IP改为当前集群的VIP，恢复业务。

### 迁移说明

1. `在线迁移可将远端集群的数据迁移到当前集群。`
2. 在线迁移时，会去远端 MySQL 通过 mysqldump 方式复制全量数据。
3. 需要提供远端 MySQL 具有 super 权限 和 复制权限 的账户，并且要求远端 MySQL 开启 GTID 模式。
4. 远端 MySQL 版本在 5.6 以下，可以参考数据迁移方案进行迁移。
5. 迁移期间，可通过 高可用写 IP 查看同步状态。
6. 为了保护集群运维账户，该服务不会同步远端 MySQL 的用户，需要使用者迁移完成后添加远端 MySQL 用户信息到本集群中。
7. 迁移前在远端集群设置 `connect_timeout=30`；远端集群和本集群均设置 `max_allowed_packets=1G`、`slave_pending_jobs_size_max=1G`、`interactive_timeout=3600`、`wait_timeout=3600`、`net_read_timeout=1800`、`net_write_timeout=1800`。
8. 迁移期间远端集群不要执行 DDL 语句。
9. 迁移期间不要在本集群控制台执行任何操作。
10. 不支持从高版本 MySQL 迁移到 低版本 MySQL。
11. 该服务仅会在主实例运行，当集群有只读实例时，服务运行失败，有 Proxy 实例不影响服务运行。
12. 开启在线迁移服务后，自动备份功能将会失效，建议暂时关闭自动备份。

## xtrabackup 方式迁移

### 操作步骤

1. 点击「 在线迁移 」，将原库 MySQL 账户名（要有 super 权限 和 复制权限）、密码、端口、IP 地址、远端集群ID 填入下图所示文本框，并选择 xtrabackup 为 `YES`，点击「 提交 」即开始迁移。
2. 等待「 在线迁移 」服务完成。服务执行完成后，当前集群就成功获取了原库的全量数据并与原库配置了主从关系，如此则可以持续同步原库增量数据到当前集群。
3. 若当前集群与原库同版本且同私有网络，可执行交换预留IP来快速切换业务。否则，按第4步切换业务。
4. 选择合适时段，切换业务到当前集群（切换时，远端 MySQL 必须要停写以保证数据一致性）：
   1. 停止原库的业务。
   2. 校验当前集群与原库数据是否一致，若一致，则继续下一步。
   3. 点击 「 结束迁移 」，会自动重启 MySQL 集群。
   4. 将业务所连IP改为当前集群的VIP，恢复业务。

### 迁移说明

1. 仅支持同一 VPC 下的集群迁移。
2. 在线迁移时，会去远端 MySQL 通过 xtrabackup 方式复制全量数据。
3. 需要提供远端 MySQL 具有 super 权限 和 复制权限 的账户，并且要求远端 MySQL 开启 GTID 模式。
4. MySQL 内核大版本要一致，不支持跨大版本迁移，比如从 MySQL-5.6 迁移到 MySQL-5.7。 不支持 MySQL-5.7.18-14 及以前的版本迁移。
5. 迁移期间，可通过 高可用写 IP 查看同步状态。
6. 该服务会同步远端 MySQL 的用户信息到本集群中。
7. 迁移期间远端集群不要执行 DDL 语句。
8. 迁移期间不要在本集群控制台执行任何操作。
9. 该服务仅会在主实例运行，当集群有只读实例时，服务运行失败，有 Proxy 实例不影响服务运行。
10. 开启在线迁移服务后，自动备份功能将会失效，建议暂时关闭自动备份。
